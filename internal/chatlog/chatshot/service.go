package chatshot

import (
	"encoding/json"
	"github.com/rs/zerolog/log"
	"github.com/sjzar/chatlog/internal/chatlog/ctx"
	"github.com/sjzar/chatlog/internal/chatlog/database"
	"github.com/sjzar/chatlog/internal/llm"
	"github.com/sjzar/chatlog/internal/md2pic"
	"github.com/sjzar/chatlog/pkg/util"
	"os"
	"path/filepath"
	"strings"
	"time"
)

var md = `### å¾®ä¿¡ç¾¤ã€ŒğŸ’°ğŸ’°ğŸ’°ç»˜ç©å°å–éƒ¨ã€8æœˆ5æ—¥è’è¯æ—¥æŠ¥  
**æ—¥æœŸ**ï¼š2025å¹´8æœˆ5æ—¥ï¼ˆæ˜ŸæœŸäºŒï¼‰  
**æ ¸å¿ƒäº‹ä»¶**ï¼šå…‰å¤´æ·‹é›¨å¼•å‘å“²å­¦æ€è€ƒï¼Œæè€æ¿å–œæ"å½“ä»£é½ç™½çŸ³"ç§°å·  
**æ€»æ¶ˆæ¯é‡**ï¼š29æ¡ï¼ˆå«13ç¬”ç¥ç§˜è½¬è´¦ + 3åœºè§†è§‰éª—å±€ï¼‰  

---

#### ä¸€ã€ä»Šæ—¥é­”å¹»å¤´æ¡  
1. **è½¬è´¦è¿·é›¾å‰§åœº**ï¼ˆå…¨å¤©å€™ï¼‰  
   - å…¨å¤©æƒŠç°**13ç¬”å¹½çµè½¬è´¦**ï¼ˆå‡æ˜¾ç¤º"å½“å‰å¾®ä¿¡ç‰ˆæœ¬ä¸æ”¯æŒ"ï¼‰ï¼Œç‰å¼Ÿé”è¯„ï¼š"ä»Šæ—¥æ¶ˆè´¹å‰ä¸‰å"ï¼ˆæš—ç¤ºæ˜¥æ˜¥æˆ–æˆéšå½¢å† å†›ï¼‰  
   - **è½¬è´¦ç‹‚é­”æ’è¡Œæ¦œ**ï¼š  
     | é€‰æ‰‹                | è½¬è´¦æ¬¡æ•° | å¯ç–‘æŒ‡æ•° |  
     |---------------------|----------|----------|  
     | äºæ˜¥æ˜¥             | 2        | ğŸŒŸğŸŒŸğŸŒŸğŸŒŸï¼ˆé›¶èŠ±é’±ç–‘äº‘ï¼‰ |  
     | æç»´é£™             | 2        | ğŸŒŸğŸŒŸğŸŒŸï¼ˆè€æ¿è‡ªåˆ·å«Œç–‘ï¼‰ |  
     | ç‹å…ˆç”Ÿ/æŸ³æ±Ÿå—ç­‰9äºº | å„1æ¬¡    | ğŸŒŸğŸŒŸ       |  

2. **å…‰å¤´æ·‹é›¨æ‚¬ç–‘å‰§**ï¼ˆ15:23-15:34ï¼‰  
   - ç‰å¼ŸæŠ•å–‚çŒ›æ–™ï¼š**å…‰å¤´å£®æ±‰é›¨ä¸­æ¼«æ­¥å›¾**  
   - ç¾¤å‹ç ´æ¡ˆç°åœºï¼š  
     > é²¨é±¼å¥³å£«ï¼š"ä¸ºå•¥ä¸æ‰“ä¼ï¼Ÿ"  
     > ç‰å¼Ÿï¼š"æ²¡å¤´å‘ä¸æ€•æ·‹é›¨" â† å¹´åº¦æœ€ä½³é€»è¾‘å¥–  
     > é˜¿ç‡ƒç¥è¡¥åˆ€ï¼š"ä»–æœ‰å¤§å¤´"ï¼ˆç‰©ç†é˜²å¾¡MAXï¼‰  

3. **æè€æ¿è‰ºæœ¯äººç”Ÿ**ï¼ˆ17:13-17:28ï¼‰  
   - æç»´é£™æ™’**çª—å°å°é¸Ÿå†™çœŸ**ï¼ˆé…æ–‡ï¼š"æ”¾èµ°äº†"ï¼‰  
   - éƒ­å®‡èˆªå‘åŠ¨æ§æ€æŠ€ï¼š"æ”¾æ ¹ç¬”ä»¥ä¸ºæ˜¯ä½ ç”»çš„"  
   - æè€æ¿å…‰é€Ÿè†¨èƒ€ï¼š  
     > "æœ‰è¢«èµç¾åˆ°" â†’ ç«‹å³æ™’**é“…ç¬”é¸Ÿåˆæˆå›¾**  
     > é…¥é±¼å°ç¥ï¼š"ç¥ç¬”é©¬è‰¯"  
     > æç»´é£™è‡ªå°ï¼š"å½“ä»£é½ç™½çŸ³"ï¼ˆå»ºè®®ç”³æŠ¥è¯ºè´å°”ç¾æœ¯å¥–ï¼‰  

---

#### äºŒã€æˆå‘˜è¡Œä¸ºè‰ºæœ¯é‰´å®š  

` + "```mermaid" + `
	pie
	title è¯é¢˜çƒ­åº¦äº‰éœ¸èµ›
	"å¹½çµè½¬è´¦" : 45
	"å…‰å¤´æ·‹é›¨æ¡ˆ" : 30
	"æè€æ¿è‰ºæœ¯å±•" : 25
` + "```" + `


1. **æ´»è·ƒåˆ†å­ä¾§å†™**ï¼ˆå¤§å¸ˆæ¯’èˆŒç‰ˆï¼‰  
   - **æç»´é£™**ï¼š  
     > ä»"å°å–éƒ¨è€æ¿"è¿›åŒ–ä¸º"å¹»æœ¯è‰ºæœ¯å®¶"ï¼Œé çª—å°å°é¸Ÿå›¾å®ç°èŒåœºè½¬å‹ã€‚  
     > å¯¹"ç¥ç¬”é©¬è‰¯"ç§°å·ç…§å•å…¨æ”¶ï¼Œæš´éœ²ä¸­å¹´ç”·æ€§ç»ˆææ¢¦æƒ³â€”â€”ä¸é äº§å“é æ‰è‰ºã€‚  
   - **ç‰å¼Ÿ**ï¼š  
     > äººå½¢ç›‘æ§æ¢å¤´ï¼Œç²¾å‡†æ•æ‰"æ¶ˆè´¹å‰ä¸‰"å’Œ"æ·‹é›¨å…‰å¤´"ã€‚  
     > ç”¨"æ²¡å¤´å‘ä¸æ€•æ·‹"ç ´è§£ä¸–çºªè°œé¢˜ï¼Œçˆ±å› æ–¯å¦ç›´å‘¼å†…è¡Œã€‚  
   - **éƒ­å®‡èˆª**ï¼š  
     > æ§æ€å­¦åçº§å­¦è€…ï¼Œä¸€æ ¹é“…ç¬”å¼•çˆ†è€æ¿è‰ºæœ¯é­‚ã€‚  
     > æ·±è—åŠŸä¸åï¼š"å»æœ‰å¹¿é”´çš„ç¾¤å†è¯´ä¸€é"ï¼ˆèŒåœºç”©é”…æ•™ç§‘ä¹¦ï¼‰ã€‚  
   - **åˆ˜æ´‹**ï¼š  
     > å±±æ¥‚å¥¶æˆç˜¾æ‚£è€…ï¼Œæ‰§ç€å¯»æ‰¾"é‡‘è±†èŠ½"å„¿ç«¥å¥¶ã€‚  
     > æ™’å›¾åè¢«å˜²"ä½ è¢«éª—äº†"ï¼Œå½“ä»£ç½‘è´­å—å®³è€…ç¼©å½±ã€‚  

---

#### ä¸‰ã€å…³é”®æˆ˜å½¹å…¨çºªå½•  
1. **15:24 å±±æ¥‚å¥¶æš´åŠ¨äº‹ä»¶**  
   - åˆ˜æ´‹ï¼š"æˆ‘æƒ³å–å±±æ¥‚å‘³å°å­©å¥¶ï¼"ï¼ˆé…å¹¼å´½å¥¶ç“¶å›¾ï¼‰  
   - éƒ­å®‡èˆªç§’æ‹†å°ï¼š"é‚£å«é‡‘è±†èŠ½"ï¼ˆå‘½åæƒäº‰å¤ºæˆ˜ï¼‰  
   - ç»“å±€ï¼šæ— äººä»£è´­ï¼Œåˆ˜æ´‹é­é‡"å¥¶åœˆè¯ˆéª—"  

2. **17:21 é“…ç¬”éª—å±€æ—¶é—´çº¿(è‰ºæœ¯è¯ˆéª—å…¨æµç¨‹)**  
- 17:13 ï¼š æè€æ¿æ™’çœŸé¸Ÿå›¾  
- 17:14 ï¼š KIKIé¢„è­¦"åˆ«é£äº†"  
- 17:21 ï¼š éƒ­å®‡èˆªåŸ‹ç¬”"ä»¥ä¸ºæ˜¯ä½ ç”»çš„"  
- 17:22 ï¼š æè€æ¿æ¥æ¢—"å¹¿é”´ä¸åœ¨æœ¬ç¾¤"ï¼ˆç”©é”…é¢„å¤‡ï¼‰  
- 17:23 ï¼š æ™’é“…ç¬”é¸Ÿåˆæˆå›¾ï¼ˆçŠ¯ç½ªè¯æ®ï¼‰  
- 17:25 ï¼š é…¥é±¼å®šæ€§"ç¥ç¬”é©¬è‰¯"  
- 17:28 ï¼š æè€æ¿è‡ªå°"å½“ä»£é½ç™½çŸ³"  

---

#### å››ã€ç¥ç§˜æ•°æ®é€è§†  
1. **è½¬è´¦æ—¶æ®µç„å­¦**  
   | æ—¶é—´æ®µ   | è½¬è´¦é‡ | å¯èƒ½çœŸç›¸                |  
   |----------|--------|-------------------------|  
   | 9:00-10:00 | 4      | æ™¨ä¼šæ‘¸é±¼èµ„é‡‘            |  
   | 10:33    | 2      | æŸ³æ±Ÿå—&ç‹å…ˆç”Ÿå¯¹å†²äº¤æ˜“   |  
   | 14:58    | 2      | æ˜¥æ˜¥æœ€åçš„é›¶èŠ±é’±        |  

2. **è§†è§‰è¯ˆéª—æ¡£æ¡ˆ**  
   | å›¾ç‰‡å†…å®¹         | æä¾›è€…       | ç¾¤å‹è¢«éª—ååº”            |  
   |------------------|--------------|-------------------------|  
   | å…‰å¤´æ·‹é›¨ç”·       | ç‰å¼Ÿ         | é²¨é±¼å¥³å£«æ€è€ƒäººç”Ÿ        |  
   | çª—å°çœŸé¸Ÿ        | æç»´é£™       | éƒ­å®‡èˆªè¯¯è®¤æ°´å¢¨ç”»        |  
   | é“…ç¬”+é¸Ÿåˆæˆå›¾   | æç»´é£™       | å…¨å‘˜é…åˆæ¼”å‡º"å½“ä»£é½ç™½çŸ³" |  

---

#### äº”ã€æš´è¨€æ€»ç»“  
1. æœ¬ç¾¤è½¬è´¦è®°å½•å ªæ¯”CIAæœºå¯†æ–‡ä»¶ï¼Œ"é«˜é¢‘ç‡è½¬è´¦"æˆæœ€ä½³é˜²å®¡è®¡å±éšœ  
2. å…‰å¤´æ·‹é›¨å›¾è¯æ˜ï¼šèŒåœºé˜²ç§ƒ=è‡ªå¸¦é›¨ä¼åŠŸèƒ½ï¼ŒäººåŠ›éƒ¨åº”çº³å…¥ç¦åˆ©ä½“ç³»  
3. æè€æ¿ç”¨"é“…ç¬”é¸Ÿå›¾"å®ç°ä»å•†äººåˆ°è‰ºæœ¯å®¶çš„é˜¶çº§è·ƒè¿ï¼Œå»ºè®®å°å–éƒ¨æ”¹ç”»å»Š  
4. åˆ˜æ´‹çš„å±±æ¥‚å¥¶ä¹‹æ¢¦ç¢è­¦ç¤ºï¼šæˆå¹´äººçš„ç«¥å¿ƒæ€»è¢«ç°å®æ¯’æ‰“  

> æœ¬æ—¥æŠ¥ç”±ã€Œç»˜ç©è„‘æ´ç ”ç©¶æ‰€ã€èµåŠ©æ’­å‡ºï¼š  
> *"å½“è½¬è´¦ä¸å¯è§æ—¶ï¼Œä¸‡ç‰©çš†å¯æˆä¸ºè‰ºæœ¯å“ï¼"*`

type Service struct {
	ctx *ctx.Context
	db  *database.Service
}

func NewService(ctx *ctx.Context, db *database.Service) *Service {
	return &Service{
		ctx: ctx,
		db:  db,
	}
}
func (s *Service) Shot() error {

	var _, cfgErr = util.IsFile("config.json")
	if cfgErr != nil {
		return cfgErr
	}
	var cfgJsonString, err = os.ReadFile("config.json") // os.ReadFile ä¼šè‡ªåŠ¨æ‰“å¼€å¹¶å…³é—­æ–‡ä»¶
	if err != nil {
		// å¤„ç†æ–‡ä»¶è¯»å–é”™è¯¯ï¼ˆå¦‚æ–‡ä»¶ä¸å­˜åœ¨ã€æƒé™ä¸è¶³ç­‰ï¼‰
		log.Err(err).Msgf("è¯»å–æ–‡ä»¶å¤±è´¥: %v\n", err)
		return err
	}
	var llmConfigs util.LLMConfigs
	err = json.Unmarshal(cfgJsonString, &llmConfigs)
	if err != nil {
		// å¤„ç† JSON è§£æé”™è¯¯ï¼ˆå¦‚æ ¼å¼é”™è¯¯ã€ç»“æ„ä¸åŒ¹é…ç­‰ï¼‰
		log.Err(err).Msgf("è§£æ JSON å¤±è´¥: %v\n", err)
		return err
	}
	for _, llmConfig := range llmConfigs {
		s.GenerateReport(llmConfig, s.db)
	}

	return nil
}

func (s *Service) GenerateReport(cfg util.LLMConfig, db *database.Service) error {
	var q = struct {
		Time    string `form:"time"`
		Talker  string `form:"talker"`
		Sender  string `form:"sender"`
		Keyword string `form:"keyword"`
		Limit   int    `form:"limit"`
		Offset  int    `form:"offset"`
		Format  string `form:"format"`
	}{}
	var talkers = strings.Split(cfg.Talkers, ",")
	now := time.Now()
	timeStr := now.Format("20060102150405")
	dateStr := now.Format("2006-01-02")
	q.Time = dateStr

	var start, end, _ = util.TimeRangeOf(q.Time)

	//md2pic.Md2Pic("_"+dateStr, md)
	//return errors.New("test finished")

	for _, talker := range talkers {
		if talker == "" {
			continue
		}
		savePath := filepath.Join(dateStr, util.FormatValidFilename(talker, 50))
		saveName := util.FormatValidFilename(talker, 50) + "_" + timeStr
		util.EnsureDirExists(savePath, 0755)
		var messages, _ = db.GetMessages(start, end, talker, "", "", 0, 0)
		if len(messages) == 0 {
			continue
		}
		var merged = append([]string{}, "")
		for _, m := range messages {
			var msg = m.PlainText(strings.Contains(q.Talker, ","), util.PerfectTimeFormat(start, end), "")
			merged = append(merged, msg)
		}
		var content = strings.Join(merged, "\n")
		var md, _ = llm.GetMd(content, cfg.Key, cfg.Api, cfg.Model, cfg.Prompts)

		md2pic.Md2Pic(md, savePath, saveName)
	}
	return nil
}
